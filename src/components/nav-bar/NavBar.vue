<template>
  <header>
    <section>
      <svg  @click="backToSearch" class="logo-svg" preserveAspectRatio="xMidYMid meet" viewBox="305 653.4000000000001 620 201" xmlns="http://www.w3.org/2000/svg" version="1.0" >
<g stroke="none"   transform="translate(0.000000,1500.000000) scale(0.080000,-0.080000)">
<path d="M4995 8400 c-67 -10 -141 -59 -186 -122 l-22 -30 47 36 c112 85 220&#10;66 333 -58 257 -281 308 -1002 94 -1333 -63 -97 -135 -143 -222 -143 -70 1&#10;-164 64 -224 150 -28 41 -63 56 -51 23 21 -55 97 -171 143 -218 72 -74 135&#10;-105 211 -105 143 0 255 117 331 345 16 50 33 111 36 138 8 55 -4 52 160 32&#10;140 -18 406 -20 490 -4 103 19 165 61 165 112 0 72 -104 176 -263 262 -70 39&#10;-105 40 -52 2 64 -46 125 -110 136 -144 10 -30 9 -39 -8 -62 -47 -62 -166 -87&#10;-383 -77 -80 3 -161 8 -180 12 l-35 6 -1 181 c0 121 -7 216 -18 282 -77 457&#10;-280 748 -501 715z"/>
<path d="M4663 8189 c-75 -22 -99 -119 -44 -178 55 -59 155 -35 181 43 26 81&#10;-53 159 -137 135z"/>
<path d="M6769 8071 c-35 -35 -36 -42 -6 -76 43 -51 164 -41 182 15 16 50 -31&#10;90 -105 90 -33 0 -48 -6 -71 -29z"/>
<path d="M7314 8030 c-58 -9 -123 -28 -141 -43 -10 -7 -13 -108 -13 -443 l0&#10;-433 22 -15 c23 -16 84 -21 125 -10 22 6 23 10 25 173 l3 166 145 6 c216 9&#10;298 48 359 171 56 111 38 248 -42 331 -50 51 -95 73 -185 92 -71 15 -212 18&#10;-298 5z m287 -111 c55 -30 85 -76 94 -139 13 -92 -10 -167 -65 -213 -42 -36&#10;-89 -47 -202 -47 l-98 0 0 209 0 210 33 4 c17 3 69 4 114 2 63 -2 91 -8 124&#10;-26z"/>
<path d="M4150 7919 c-71 -12 -155 -51 -170 -79 -17 -31 -6 -83 25 -124 24&#10;-32 124 -116 137 -116 4 0 15 15 26 34 l20 34 -40 38 c-101 99 -89 164 38 204&#10;63 20 52 23 -36 9z"/>
<path d="M9022 7845 c-67 -19 -156 -61 -173 -82 -11 -13 -15 -100 -17 -427 -2&#10;-226 0 -425 3 -443 5 -27 12 -34 45 -44 27 -8 53 -9 82 -3 l43 9 3 138 3 138&#10;32 -7 c18 -4 75 -7 127 -6 167 0 276 63 336 195 26 56 29 73 29 167 0 141 -19&#10;194 -100 276 -42 42 -75 66 -110 78 -69 25 -233 31 -303 11z m225 -96 c84 -41&#10;118 -115 117 -259 0 -123 -15 -174 -68 -226 -66 -66 -162 -81 -252 -38 l-34&#10;16 0 248 0 248 38 15 c55 23 147 21 199 -4z"/>
<path d="M8228 7810 c-68 -11 -150 -44 -174 -71 -17 -19 -17 -21 3 -47 25 -32&#10;39 -32 120 2 175 74 293 27 293 -116 0 -67 12 -61 -158 -78 -171 -16 -270 -62&#10;-302 -140 -18 -43 -9 -144 16 -178 33 -44 107 -88 172 -102 132 -28 329 1 412&#10;60 l30 21 0 237 c0 209 -3 242 -19 278 -24 52 -83 101 -144 119 -64 19 -179&#10;26 -249 15z m242 -504 l0 -124 -34 -12 c-19 -6 -66 -11 -105 -11 -114 -1 -161&#10;38 -161 133 0 94 65 128 263 136 l37 2 0 -124z"/>
<path d="M9957 7810 c-162 -28 -272 -155 -284 -328 -17 -247 120 -396 377&#10;-409 109 -6 195 11 260 52 46 29 50 52 15 85 l-25 23 -71 -36 c-61 -32 -81&#10;-37 -138 -37 -119 0 -195 55 -234 171 -8 24 -14 45 -13 46 1 1 103 16 226 33&#10;124 16 242 35 262 41 47 12 62 38 53 92 -23 139 -124 239 -270 266 -65 12 -88&#10;12 -158 1z m140 -91 c46 -17 92 -69 108 -123 26 -86 35 -80 -157 -105 -95 -12&#10;-181 -25 -190 -27 -15 -4 -18 1 -18 29 0 51 27 132 56 167 51 61 133 85 201&#10;59z"/>
<path d="M10723 7795 c-71 -19 -148 -60 -167 -87 -14 -19 -16 -65 -16 -314 l0&#10;-291 25 -11 c29 -13 67 -15 114 -6 l31 7 0 294 0 294 38 16 c48 21 144 30 206&#10;21 33 -5 54 -3 63 4 21 17 11 61 -17 75 -34 17 -211 16 -277 -2z"/>
<path d="M6778 7793 c-17 -4 -18 -29 -18 -343 0 -339 0 -339 22 -354 23 -16&#10;84 -21 126 -10 l22 6 0 344 0 344 -26 10 c-25 10 -94 12 -126 3z"/>
<path d="M4302 7694 c-46 -23 -89 -77 -102 -125 -21 -78 6 -152 76 -205 33&#10;-26 46 -29 110 -29 66 0 75 3 112 32 l41 33 43 -19 c126 -54 626 -201 684&#10;-201 9 0 26 67 20 77 -1 1 -55 14 -121 28 -137 31 -405 110 -514 153 l-74 29&#10;-2 55 c-2 65 -24 108 -78 151 -31 26 -48 32 -100 34 -43 3 -72 -1 -95 -13z"/>
<path d="M5745 7703 c-96 -25 -124 -146 -49 -212 62 -55 150 -37 189 39 19 37&#10;19 64 -1 105 -24 52 -86 81 -139 68z"/>
<path d="M4691 7179 c-52 -48 -51 -120 1 -164 27 -23 39 -26 75 -22 51 5 71&#10;20 90 66 19 44 9 84 -29 116 -39 33 -104 35 -137 4z"/>
</g>
      </svg>
      <!-- <h1>iPaper<span>{{ $t('web_name_text') }}</span></h1> -->
    </section>
    <section>
      <!-- <button >{{ $t('language') }}</button> -->
      <svg @click="tShouldShow=true" t="1703582666161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5393" width="200" height="200"><path d="M578.077439 516.374634c42.958394-21.671579 96.395444-48.649 96.395444-121.723296 0-83.250052-71.785953-141.397381-174.600597-141.397381-74.789357 0-140.688229 42.880623-163.963329 106.702184-5.362124 14.70798-9.982352 39.135322-5.408173 59.629075 2.771113 12.368702 15.108093 20.12434 27.435862 17.407462 12.384052-2.771113 20.166295-15.052834 17.408485-27.434839-1.861394-8.345062-0.26913-22.903639 3.723811-33.865295 13.887288-38.078247 56.622602-76.493162 120.80232-76.493162 75.758428 0 128.659265 39.245839 128.659265 95.452979 0 42.643216-27.03575 58.45125-71.139224 80.71123-38.406728 19.386536-86.210477 43.514049-86.210477 103.133915l0 56.841589c0 12.691043 10.275018 22.982434 22.972201 22.982434 12.69616 0 22.970154-10.29139 22.970154-22.982434l0-56.841589C517.125229 548.601616 539.158035 536.02723 578.077439 516.374634z" fill="#5D5D5D" p-id="5394"></path><path d="M459.701378 734.025723c0 19.034519 15.426341 34.458813 34.458813 34.458813 19.028379 0 34.458813-15.424294 34.458813-34.458813 0-19.028379-15.430434-34.45779-34.458813-34.45779C475.127719 699.567933 459.701378 714.997344 459.701378 734.025723z" fill="#5D5D5D" p-id="5395"></path><path d="M946.428785 511.4863c0-241.053078-195.409528-436.46363-436.485119-436.46363C268.885472 75.000158 73.476967 270.406616 73.476967 511.4863c0 241.059218 195.410552 436.467723 436.485119 436.467723 98.950639 0 189.598172-33.67189 262.800381-89.152483 3.01159-3.402493 4.989641-7.768941 4.989641-12.666484 0-10.688433-8.66945-19.35072-19.351744-19.35072-5.564739 0-10.508331 2.204202-14.000875 5.931083l-0.273223 0c-65.50797 48.216141-146.156778 77.086679-233.725182 77.086679-218.279399 0-395.254066-177.00025-395.254066-395.280672 0-218.301911 176.974667-395.253042 395.254066-395.253042 218.302935 0 395.254066 176.951131 395.254066 395.253042 0 66.680678-15.626909 129.421628-44.794206 184.559413l0 0.324388c-0.525979 1.833765-1.12666 3.629667-1.12666 5.607718 0 10.688433 8.66638 19.352767 19.354813 19.352767 8.292873 0 15.260565-5.335519 17.992793-12.71151l0 0.1361C928.110581 651.735531 946.428785 583.771627 946.428785 511.4863z" fill="#5D5D5D" p-id="5396"></path></svg>
      <svg @click="translate" t="1700014496111" class="icon" viewBox="0 0 1024 1024" version="1.1"
        xmlns="http://www.w3.org/2000/svg" p-id="4957" width="200" height="200">
        <path
          d="M360.228571 505.234286c-8.594286 0-12.8-4.388571-12.8-13.165715v-74.24h-76.068571c-5.12 0-9.325714-1.645714-12.617143-4.937142s-4.754286-7.68-4.754286-12.982858v-81.005714c0-5.302857 1.645714-9.691429 4.754286-12.982857s7.497143-4.937143 12.617143-4.937143H347.428571v-34.742857c0-8.777143 4.205714-13.165714 12.8-13.165714s12.8 4.388571 12.8 13.165714v34.742857h77.165715c5.12 0 9.325714 1.645714 12.617143 4.937143s4.754286 7.68 4.754285 12.982857v81.005714c0 5.302857-1.645714 9.691429-4.754285 12.982858s-7.497143 4.937143-12.617143 4.937142H373.028571v74.24c0 8.777143-4.205714 13.165714-12.8 13.165715z m-75.337142-112.64H347.428571v-66.56h-62.537142c-4.205714 0-6.4 2.194286-6.4 6.582857v53.394286c0 4.388571 2.194286 6.582857 6.4 6.582857z m88.137142 0h62.537143c4.205714 0 6.4-2.194286 6.4-6.582857v-53.394286c0-4.388571-2.194286-6.582857-6.4-6.582857H373.028571v66.56zM704.548571 694.674286h-78.445714l-15.908571 50.285714c-2.011429 0.914286-4.022857 1.645714-6.217143 2.011429-2.194286 0.548571-4.754286 0.731429-7.68 0.731428-5.302857 0-9.691429-1.28-13.165714-3.657143-3.474286-2.377143-5.12-6.034286-5.12-10.971428 0-2.377143 0.365714-4.754286 0.914285-6.948572 0.548571-2.377143 1.462857-4.937143 2.56-7.862857 2.925714-9.142857 6.765714-21.028571 11.702857-35.84s10.422857-30.171429 16.091429-46.445714c5.668571-16.274286 11.52-32.182857 17.371429-48.091429s10.788571-29.257143 15.177142-40.411428c2.194286-1.28 5.485714-2.56 9.874286-3.84s8.96-2.011429 13.714286-2.011429c6.217143 0 11.885714 0.914286 16.822857 2.742857 4.937143 1.828571 8.228571 4.937143 10.057143 9.325715 4.571429 12.434286 9.874286 26.697143 15.36 42.605714 5.668571 15.908571 11.154286 32.365714 16.822857 49.371428 5.485714 17.005714 10.971429 33.645714 16.091429 49.737143 5.12 16.274286 9.874286 30.902857 13.897142 44.251429-2.011429 2.194286-4.571429 4.022857-7.68 5.485714-3.108571 1.462857-6.765714 2.194286-11.154285 2.194286-5.668571 0-9.874286-1.097143-12.434286-3.474286s-4.754286-6.217143-6.582857-11.702857l-12.068572-37.485714z m-39.497142-121.965715c-2.194286 5.851429-4.571429 12.617143-7.131429 20.114286-2.56 7.497143-5.302857 15.36-8.045714 23.588572-2.742857 8.228571-5.485714 16.64-8.228572 25.051428-2.742857 8.411429-5.485714 16.64-7.862857 24.685714h63.268572c-2.925714-8.777143-5.668571-17.737143-8.594286-26.697142-2.925714-8.96-5.668571-17.554286-8.228572-25.6s-5.12-15.725714-7.497142-22.857143c-2.377143-7.131429-4.205714-13.348571-5.851429-18.468572h-1.828571z"
          p-id="4958"></path>
        <path
          d="M521.142857 606.171429H189.622857a65.097143 65.097143 0 0 1-65.097143-64.914286V202.605714c0-35.84 29.257143-65.097143 65.097143-65.097143H521.142857c35.84 0 64.914286 29.257143 64.914286 65.097143V541.257143a64.914286 64.914286 0 0 1-64.914286 64.914286zM189.622857 174.08c-15.725714 0-28.525714 12.8-28.525714 28.525714V541.257143c0 15.725714 12.8 28.342857 28.525714 28.342857H521.142857c15.725714 0 28.342857-12.8 28.342857-28.342857V202.605714c0-15.725714-12.8-28.525714-28.342857-28.525714H189.622857z"
          p-id="4959"></path>
        <path
          d="M834.56 886.491429H503.04a65.097143 65.097143 0 0 1-65.097143-64.914286V587.885714c0-10.057143 8.228571-18.285714 18.285714-18.285714h64.914286c15.725714 0 28.342857-12.8 28.342857-28.342857v-105.142857c0-10.057143 8.228571-18.285714 18.285715-18.285715h266.788571c35.84 0 64.914286 29.257143 64.914286 65.097143v338.651429a64.914286 64.914286 0 0 1-64.914286 64.914286zM474.514286 606.171429v215.405714c0 15.725714 12.8 28.342857 28.525714 28.342857h331.52c15.725714 0 28.342857-12.8 28.342857-28.342857V482.925714c0-15.725714-12.8-28.525714-28.342857-28.525714H586.057143v86.857143a64.914286 64.914286 0 0 1-64.914286 64.914286h-46.628571z"
          p-id="4960"></path>
      </svg>
      <template v-if="!isLoggedIn">
        <button class="basic-btn" @click="loginModalShouldShow = true">{{ $t('login_text') }}</button>
        <button class="basic-btn-outline" @click="registerModalShouldShow = true">{{ $t('register_text') }}</button>
        <div class="dropdown-icon">
          <ul class="dropdown-list">
            <li @click="loginModalShouldShow = true">{{ $t('login_text') }}</li>
            <li @click="registerModalShouldShow = true">{{ $t('register_text') }}</li>
          </ul>
        </div>
      </template>
      <template v-else>
        
        <div @click="jumpToMessage">
          <div v-if="!hasUnreadMessage">
            <MailIcon></MailIcon>
          </div>
          <div v-else>
            <UnreadMailIcon></UnreadMailIcon>
          </div>
        </div>
        <a class="homepage-link">
          <div>{{ $t('hello_message') + currentUsername }}</div>
          <ul class="dropdown-list">
            <li @click="jumpToPersonalHomepage">{{ $t('personal_homepage_text') }}</li>
            <li @click="jumpToChangePassword">{{ $t('change_password_text') }}</li>
            <li @click="handleLogout">{{ $t('logout_text') }}</li>
          </ul>
        </a>
      </template>
    </section>
  </header>
  <LoginModal :show="loginModalShouldShow" @close="loginModalShouldShow = false"
    @jumpToRigister="registerModalShouldShow = true" @jumpToRetrievePassword="retrievePasswordModalShouldShow = true" />

  <RegisterModal :show="registerModalShouldShow" @close="registerModalShouldShow = false"
    @jumpToLogin="loginModalShouldShow = true" />

  <RetrievePasswordModal :show="retrievePasswordModalShouldShow" @close="retrievePasswordModalShouldShow = false" />

  <ChangePasswordModal :show="changePasswordModalShow" @close="changePasswordModalShow = false" />

  <tutorial-view v-if="tShouldShow" :display="tShouldShow" @hide="tShouldShow = false"/>

</template>

<script>
import { mapState, mapMutations } from 'vuex'



import LoginModal from '../modals/LoginModal.vue'
import RegisterModal from '../modals/RegisterModal.vue'
import RetrievePasswordModal from '../modals/RetrievePasswordModal.vue'
import MailIcon from '../svg/MailIcon.vue'
import UnreadMailIcon from '../svg/UnreadMailIcon.vue'
import ChangePasswordModal from '../modals/ChangePasswordModal.vue'

import { Account } from '../../api/accounts.js'
import { User } from '../../api/users.js'

import i18n from '../../language'
import TutorialView from '../../views/tutorialView/TutorialView.vue'
export default {
  name: 'NavBar',
  components: {
    LoginModal,
    RegisterModal,
    RetrievePasswordModal,
    ChangePasswordModal,
    i18n,
    MailIcon,
    UnreadMailIcon,
    TutorialView
  },
  data() {
    return {
      tShouldShow: false,
      hasUnreadMessage: false,
      loginModalShouldShow: false,
      registerModalShouldShow: false,
      retrievePasswordModalShouldShow: false,
      changePasswordModalShow: false,
      currentUsername: ''
    }
  },
  computed: {
    ...mapState(['isLoggedIn'])
  },
  watch: {
    isLoggedIn(newValue) {
      if (newValue === true) {
        this.getUserIdAndSayHello()
      }
    }
  },
  mounted() {
    // console.log(this.$cookies.get('user_id'))
    this.$bus.on('judgeHasUnreadMsg', this.handleJudgeHasUnreadMsg)
    this.getUserIdAndSayHello()
  },
  methods: {
    ...mapMutations(['setIsLoggedIn']),
    getUserIdAndSayHello() {
      let userId = this.$cookies.get('user_id')
      if (userId) {
        this.setIsLoggedIn(true)
        User.getUser(userId).then(
          (response) => {
            this.currentUsername = response.data.username
          },
          (error) => {
            console.log(error)
          }
        )
      }
    },
    // mq: 跳转到消息详情页面
    jumpToMessage() {
      this.$router.push('/message')
    },
    backToSearch() {
      let userId = this.$cookies.get('user_id')
      if (userId) {
        this.$router.push('/search')
      } else {
        this.$router.push('/')
      }
    },
    translate() {
      document.documentElement.classList.add('document-fade-out')
      setTimeout(() => {
        document.documentElement.classList.remove('document-fade-out')
        if (this.$i18n.locale == 'zh') {
          this.$i18n.locale = 'en'
        }
        else {
          this.$i18n.locale = 'zh'
        }
        document.documentElement.classList.add('document-fade-in')
        setTimeout(() => {
          document.documentElement.classList.remove('document-fade-in')
        }, 610)
      }, 200)
    },
    jumpToPersonalHomepage() {
      this.$router.push('/personal_homepage')
    },
    handleLogout() {
      Account.logout().then(
        (response) => {
          // alert("登出成功！")
          this.setIsLoggedIn(false)
          this.$router.push('/')
        },
        (error) => {
          // alert("登出失败！")
        }
      )
    },
    jumpToChangePassword() {
      console.log(111);
      this.changePasswordModalShow = true
    },
    testCopy() {
      let str = "Hello World"
      navigator.clipboard.writeText(str)
    }
  }
}
</script>

<style scoped>
svg.logo-svg {
  width: 200px;
  height: 140px;
  cursor: pointer;
  translate: 0 -40px;
  fill: var(--theme-color) !important;
  /* margin-right: 500px; */
}

.click-svg {
  position: fixed;
  z-index: 100;
  width: 240px;
  height: 0px;
  cursor: pointer;
  translate: -80px 0;
  fill: var(--theme-color) !important;
  /* margin-right: 500px; */
}

header {
  position: sticky;
  top: 0;
  width: 98.5%;
  height: 60px;
  background: var(--theme-mode);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 10px;
  z-index: 999;
}

header>section {
  display: flex;
  align-items: center;
}

header h1,
header h1 span {
  font-size: 25px;
  /* font-weight: bold; */
  color: var(--theme-color);
}

header h1 {
  margin-left: 10px;
}

.logo {
  width: 40px;
  height: 40px;
  background: green;
  border-radius: 50%;
  flex: none;
}

header button {
  margin: 0 10px;
}

.dropdown-icon {
  width: 40px;
  height: 40px;
  background: url('../../components/svg/menu.svg');
  background-size: cover;
  display: none;
  cursor: pointer;
  position: relative;
  transition: .5s cubic-bezier(0.075, 0.82, 0.165, 1);
}

.dropdown-list {
  position: absolute;
  top: calc(100%);
  right: -10px;
  padding: 10px;
  background: var(--theme-mode-like);
  border-radius: 5px;
  display: none;
}

.dropdown-list li {
  width: 100px;
  display: flex;
  justify-content: center;
  background: var(--theme-mode-contrast);
  color: var(--theme-mode-high-contrast);
  font-size: 16px;
  font-weight: bold;
  padding: 5px;
  border-radius: 5px;
  transition: .3s cubic-bezier(0.075, 0.82, 0.165, 1);
  text-align: center;
}

.dropdown-list li:not(:last-child) {
  margin-bottom: 10px;
}

.dropdown-list li:hover {
  scale: 1.05;
}

.icon {
  width: 40px;
  height: 40px;
  background-size: cover;
  cursor: pointer;
  transition: 1s cubic-bezier(0.075, 0.82, 0.165, 1);
  fill: #666;
  vertical-align: middle;
}

.icon:hover {
  scale: 1.2;
  fill: var(--theme-color);
}

header svg {
  margin: 0 10px;
}

.homepage-link {
  margin-right: 10px;
  position: relative;
}

.homepage-link div {
  font-size: 18px;
  color: var(--theme-color);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.homepage-link:hover .dropdown-list {
  display: block;
}

@media screen and (max-width: 1000px) {

  header h1,
  header h1 span {
    font-size: 20px;
  }
}

@media screen and (max-width: 850px) {
  .icon {
    width: 40px;
    height: 40px;
  }
}

@media screen and (max-width: 768px) {
  .dropdown-icon {
    display: block;
  }

  .dropdown-icon:hover ul {
    display: block;
  }

  header button {
    display: none;
  }

  header h1 span {
    display: none;
  }
}

@media screen and (max-width: 600px) {
  .dropdown-icon {
    width: 40px;
    height: 40px;
  }

  .homepage-link div {
    max-width: 150px;
  }
}
</style>